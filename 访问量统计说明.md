# 软件官网访问量统计系统

## 系统概述

这是一个完整的网站访问量统计系统，可以实时监控和分析网站的访问情况，包括每日访问量、用户行为、设备分布等关键指标。

## 功能特性

### 1. 实时统计
- **当前在线用户数**：实时显示当前正在访问网站的用户数量
- **今日访问量**：统计当天的总访问次数
- **今日下载量**：统计当天的软件下载次数
- **平均访问时长**：计算用户的平均停留时间

### 2. 每日统计
- **访问量趋势**：按日期显示访问量变化趋势
- **独立访客数**：统计不重复的访问用户数量
- **跳出率分析**：分析用户离开网站的比例
- **设备类型分布**：统计桌面端、移动端、平板端的访问比例
- **语言分布**：分析用户使用的语言偏好
- **来源渠道分析**：统计用户访问的来源网站

### 3. 用户行为分析
- **会话时长统计**：分析用户在网站的停留时间
- **页面访问路径**：追踪用户在网站内的浏览路径
- **下载行为分析**：统计软件下载的转化率
- **时区分布分析**：统计用户的地理位置分布
- **平台偏好分析**：分析用户使用的操作系统平台
- **屏幕分辨率分析**：统计用户的设备屏幕规格
- **设备像素比分析**：了解高DPI设备的普及程度

## 技术实现

### 前端实现

#### 1. 用户识别
使用 FingerprintJS 生成唯一设备ID，确保准确统计独立访客：

```typescript
// components/layout/index.tsx
const judgeHasUuid = (callBack: any) => {
  if (!localStorage.getItem('uuid')) {
    FingerprintJS.load().then((fp) => {
      fp.get().then((result) => {
        const visitorId = result.visitorId;
        localStorage.setItem('uuid', visitorId);
        callBack();
      });
    });
  } else {
    callBack();
  }
};
```

#### 1.1. 时区获取
使用多种方法获取浏览器时区信息：

```typescript
// utils/timezone.ts
export const getBrowserTimezone = (): TimezoneInfo => {
  let timezone = 'UTC';
  let offset = '+00:00';
  let offsetMinutes = 0;
  let isDST = false;
  let region = 'Unknown';

  try {
    // 方法1: 使用 Intl.DateTimeFormat (推荐)
    const dateTimeFormat = Intl.DateTimeFormat();
    const resolvedOptions = dateTimeFormat.resolvedOptions();
    timezone = resolvedOptions.timeZone;
    
    // 获取时区偏移
    const now = new Date();
    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
    const targetTime = new Date(utc + (0 * 60000));
    const offsetMs = targetTime.getTime() - now.getTime();
    offsetMinutes = Math.round(offsetMs / 60000);
    
    // 格式化偏移字符串
    const hours = Math.abs(Math.floor(offsetMinutes / 60));
    const minutes = Math.abs(offsetMinutes % 60);
    offset = \`\${offsetMinutes >= 0 ? '+' : '-'}\${hours.toString().padStart(2, '0')}:\${minutes.toString().padStart(2, '0')}\`;
    
    // 检测夏令时
    const jan = new Date(now.getFullYear(), 0, 1);
    const jul = new Date(now.getFullYear(), 6, 1);
    const janOffset = jan.getTimezoneOffset();
    const julOffset = jul.getTimezoneOffset();
    isDST = Math.min(janOffset, julOffset) === now.getTimezoneOffset();
    
    // 提取地区信息
    if (timezone.includes('/')) {
      region = timezone.split('/').pop() || 'Unknown';
    } else {
      region = timezone;
    }
    
  } catch (error) {
    // 方法2: 降级处理，使用 getTimezoneOffset
    const offsetMinutes = new Date().getTimezoneOffset();
    const hours = Math.abs(Math.floor(offsetMinutes / 60));
    const minutes = Math.abs(offsetMinutes % 60);
    
    timezone = \`UTC\${offsetMinutes <= 0 ? '+' : '-'}\${hours.toString().padStart(2, '0')}:\${minutes.toString().padStart(2, '0')}\`;
    offset = \`\${offsetMinutes <= 0 ? '+' : '-'}\${hours.toString().padStart(2, '0')}:\${minutes.toString().padStart(2, '0')}\`;
    region = 'Unknown';
  }

  return {
    timezone,
    offset,
    offsetMinutes,
    isDST,
    region
  };
};
```

#### 1.2. 屏幕分辨率获取
获取用户的屏幕分辨率和设备信息：

```typescript
// utils/screen.ts
export const getScreenInfo = (): ScreenInfo => {
  const screen = window.screen;
  const devicePixelRatio = window.devicePixelRatio || 1;
  
  // 获取屏幕基本信息
  const width = screen.width;
  const height = screen.height;
  const availWidth = screen.availWidth;
  const availHeight = screen.availHeight;
  const colorDepth = screen.colorDepth;
  const pixelDepth = screen.pixelDepth;
  
  // 获取屏幕方向
  let orientation = {
    type: 'landscape-primary',
    angle: 0
  };
  
  try {
    if (screen.orientation) {
      orientation = {
        type: screen.orientation.type,
        angle: screen.orientation.angle
      };
    }
  } catch (error) {
    // 降级处理，通过宽高比判断方向
    orientation = {
      type: width > height ? 'landscape-primary' : 'portrait-primary',
      angle: 0
    };
  }
  
  // 判断屏幕尺寸类型
  const screenSize = getScreenSizeType(width, height);
  
  // 判断设备类型
  const deviceType = getDeviceType(width, height, devicePixelRatio);
  
  return {
    width,
    height,
    availWidth,
    availHeight,
    colorDepth,
    pixelDepth,
    orientation,
    devicePixelRatio,
    logicalPixelRatio: devicePixelRatio,
    screenSize,
    deviceType
  };
};
```

#### 2. 访问记录
页面加载时自动记录访问信息，包括时区信息：

```typescript
const iLoginWeb = () => {
  const originUrl = document.referrer || 'direct';
  const uuid = localStorage.getItem('uuid') || '';
  let platform = 'Windows';
  
  // 获取平台信息
  try {
    platform = (navigator as any).userAgentData.platform;
  } catch (error) {
    // 降级处理，使用userAgent判断
    const userAgent = navigator.userAgent;
    if (userAgent.includes('Mac')) {
      platform = 'macOS';
    } else if (userAgent.includes('Linux')) {
      platform = 'Linux';
    } else if (userAgent.includes('Android')) {
      platform = 'Android';
    } else if (userAgent.includes('iOS')) {
      platform = 'iOS';
    }
  }
  
      // 获取浏览器时区
    const timezoneInfo = getBrowserTimezone();
    
    // 获取屏幕信息
    const screenInfo = getScreenInfo();
    
    loginWeb({
      deviceType: navigator.userAgent,
      lang: navigator.language,
      platform,
      timezone: timezoneInfo.timezone,
      screenInfo: {
        width: screenInfo.width,
        height: screenInfo.height,
        devicePixelRatio: screenInfo.devicePixelRatio,
        screenSize: screenInfo.screenSize,
        deviceType: screenInfo.deviceType
      },
      comeTime: new Date().getTime(),
      uuid,
      originUrl,
    });
};
```

#### 3. 离开记录
页面关闭时记录离开时间：

```typescript
const iLogOutWeb = () => {
  if (!localStorage.getItem('uuid')) {
    return;
  }
  logOutWeb({
    leaveTime: new Date().getTime(),
    uuid: localStorage.getItem('uuid') || '',
  });
};
```

### 后端实现

#### 1. API接口
- `POST /v1/login` - 记录用户访问
- `POST /v1/loginOut` - 记录用户离开
- `POST /v1/clickDown` - 记录下载点击
- `GET /v1/getData` - 获取统计数据
- `GET /v1/dailyStats` - 获取每日统计数据
- `GET /v1/realTimeStats` - 获取实时统计数据

#### 2. 数据存储
```javascript
// 访问数据存储
let visitData = [];
let onlineUsers = new Map();

// 记录访问
app.post('/v1/login', (req, res) => {
  const { deviceType, lang, comeTime, uuid, originUrl } = req.body;
  
  const visitRecord = {
    id: Date.now(),
    deviceType,
    lang,
    comeTime,
    uuid,
    originUrl,
    leaveTime: null,
    loginNum: 1,
    clickNum: 0
  };
  
  // 检查重复访问
  const existingRecord = visitData.find(record => record.uuid === uuid);
  if (existingRecord) {
    existingRecord.loginNum += 1;
    existingRecord.comeTime = comeTime;
  } else {
    visitData.push(visitRecord);
  }
  
  // 添加到在线用户
  onlineUsers.set(uuid, {
    uuid,
    deviceType,
    visitTime: comeTime,
    currentPage: req.headers.referer || '/'
  });
});
```

#### 3. 数据统计
```javascript
// 每日统计计算
app.get('/v1/dailyStats', (req, res) => {
  const { startDate, endDate } = req.query;
  
  // 按日期分组统计
  const dailyStats = {};
  
  visitData.forEach(record => {
    const date = new Date(record.comeTime).toISOString().split('T')[0];
    
    if (date >= startDate && date <= endDate) {
      if (!dailyStats[date]) {
        dailyStats[date] = {
          date,
          totalVisits: 0,
          uniqueVisitors: new Set(),
          totalDownloads: 0,
          sessionDurations: [],
          deviceStats: { desktop: 0, mobile: 0, tablet: 0 },
          languageStats: {},
          referrers: {}
        };
      }
      
      // 统计各项指标...
    }
  });
});
```

## 使用方法

### 1. 启动统计服务
```bash
# 安装依赖
npm install express cors

# 启动统计服务
node server-example.js
```

### 2. 访问统计页面
- 访问 `/admin` 查看基础统计数据
- 访问 `/daily-stats` 查看详细的每日访问量统计

### 3. 配置代理
在 `server.js` 中配置API代理：

```javascript
const devProxy = {
  '/api': {
    target: 'http://127.0.0.1:2202',
    pathRewrite: {
      '^/api': '/',
    },
    changeOrigin: true,
  },
};
```

## 数据指标说明

### 访问量指标
- **总访问量**：页面被访问的总次数
- **独立访客**：不重复的访问用户数量
- **跳出率**：只访问一个页面就离开的用户比例
- **平均会话时长**：用户在网站的平均停留时间

### 设备分析
- **桌面端**：PC电脑访问
- **移动端**：手机访问
- **平板端**：平板设备访问

### 用户行为
- **来源渠道**：用户从哪个网站跳转而来
- **语言偏好**：用户使用的浏览器语言
- **访问路径**：用户在网站内的浏览轨迹

## 优化建议

### 1. 性能优化
- 使用Redis缓存热点数据
- 实现数据分页加载
- 定期清理过期数据

### 2. 数据准确性
- 过滤机器人访问
- 处理用户清除缓存的情况
- 考虑时区问题

### 3. 功能扩展
- 添加用户画像分析
- 实现A/B测试统计
- 集成第三方统计工具

## 注意事项

1. **隐私保护**：确保符合GDPR等隐私法规
2. **数据安全**：定期备份重要数据
3. **系统监控**：监控API性能和错误率
4. **数据清理**：定期清理过期数据，避免存储空间不足

## 故障排除

### 常见问题
1. **统计数据不准确**：检查UUID生成和存储逻辑
2. **API请求失败**：检查网络连接和代理配置
3. **页面加载缓慢**：优化数据查询和缓存策略

### 调试方法
1. 查看浏览器控制台错误信息
2. 检查服务器日志
3. 验证API接口返回数据格式

这个统计系统为您的软件官网提供了全面的访问量分析功能，帮助您了解用户行为，优化网站体验，提升转化率。 